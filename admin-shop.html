<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì  ê´€ë¦¬ - ìºì‹œë´‡ ê´€ë¦¬ì</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            color: #2d3436;
        }
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .card h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2d3436;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .image-preview {
            width: 200px;
            height: 200px;
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-text {
            color: #95a5a6;
            text-align: center;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .product-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }
        .product-card-info {
            padding: 15px;
        }
        .product-card-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3436;
        }
        .product-card-price {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }
        .product-card-actions {
            display: flex;
            gap: 5px;
        }
        .product-card-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d3436;
        }
        .orders-table img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-approved {
            background: #e3f2fd;
            color: #1565c0;
        }
        .status-preparing {
            background: #fff3e0;
            color: #e65100;
        }
        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3436;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ ìƒì  ê´€ë¦¬</h1>
            <p>ìƒí’ˆ ë“±ë¡, ì£¼ë¬¸ ê´€ë¦¬, ì¿ í° ë°œê¸‰ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('products')">ìƒí’ˆ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('orders')">ì£¼ë¬¸ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="location.href='admin.html'">â† ë©”ì¸ìœ¼ë¡œ</button>
        </div>

        <!-- ìƒí’ˆ ê´€ë¦¬ íƒ­ -->
        <div id="products-tab" class="tab-content active">
            <div class="card">
                <h2>ìƒˆ ìƒí’ˆ ë“±ë¡</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label class="form-label">ìƒí’ˆëª…</label>
                        <input type="text" class="form-input" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ê°€ê²© (ì›)</label>
                        <input type="number" class="form-input" id="productPrice" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìƒí’ˆ ì´ë¯¸ì§€ (1:1 ë¹„ìœ¨ ê¶Œì¥)</label>
                        <input type="file" class="form-input" id="productImage" accept="image/*" required>
                        <div class="image-preview" id="imagePreview">
                            <div class="image-preview-text">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”<br>(1:1 ë¹„ìœ¨)</div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ìƒí’ˆ ë“±ë¡</button>
                </form>
            </div>

            <div class="card">
                <h2>ë“±ë¡ëœ ìƒí’ˆ</h2>
                <div class="products-grid" id="productsList"></div>
            </div>
        </div>

        <!-- ì£¼ë¬¸ ê´€ë¦¬ íƒ­ -->
        <div id="orders-tab" class="tab-content">
            <div class="card">
                <h2>ì£¼ë¬¸ ëª©ë¡</h2>
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>ì£¼ë¬¸ì¼</th>
                            <th>ìƒí’ˆ</th>
                            <th>êµ¬ë§¤ì</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h3 class="modal-title">ì£¼ë¬¸ ìƒì„¸ ê´€ë¦¬</h3>
            <div id="orderDetailContent"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://apuiydnqimlmeqpftijl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwdWl5ZG5xaW1sbWVxcGZ0aWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MTgzMDAsImV4cCI6MjA4NTA5NDMwMH0.G7CvTQLEsIzkhJfsa67ou28Pbt8J5bkbEvyEgSRziXI';

        let currentOrder = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadOrders();

            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
            document.getElementById('productImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                    }
                    reader.readAsDataURL(file);
                }
            });

            // ìƒí’ˆ ë“±ë¡ í¼
            document.getElementById('productForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addProduct();
            });
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        async function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const imageFile = document.getElementById('productImage').files[0];

            if (!imageFile) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const imageUrl = e.target.result;

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/products`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            name: name,
                            price: price,
                            image_url: imageUrl,
                            is_active: true
                        })
                    });

                    if (response.ok) {
                        alert('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        document.getElementById('productForm').reset();
                        document.getElementById('imagePreview').innerHTML = '<div class="image-preview-text">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”<br>(1:1 ë¹„ìœ¨)</div>';
                        await loadProducts();
                    } else {
                        throw new Error('ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨');
                    }
                };
                reader.readAsDataURL(imageFile);
            } catch (error) {
                console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', error);
                alert('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                
                const products = await response.json();
                const list = document.getElementById('productsList');

                if (products.length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #95a5a6;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                list.innerHTML = products.map(product => `
                    <div class="product-card">
                        <img src="${product.image_url}" alt="${product.name}">
                        <div class="product-card-info">
                            <div class="product-card-name">${product.name}</div>
                            <div class="product-card-price">${product.price.toLocaleString()}ì›</div>
                            <div class="product-card-actions">
                                <button class="btn btn-${product.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleProduct(${product.id}, ${!product.is_active})">
                                    ${product.is_active ? 'íŒë§¤ì¤‘ì§€' : 'íŒë§¤ì‹œì‘'}
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduct(${product.id})">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function toggleProduct(productId, isActive) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${productId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });

                await loadProducts();
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadProducts();
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/orders?order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                
                const orders = await response.json();
                const tbody = document.getElementById('ordersTableBody');

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #95a5a6;">ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                // ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userIds = [...new Set(orders.map(o => o.user_id))];
                const usersResponse = await fetch(`${SUPABASE_URL}/rest/v1/users?id=in.(${userIds.join(',')})`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                const users = await usersResponse.json();
                const userMap = {};
                users.forEach(u => userMap[u.id] = u.nickname);

                tbody.innerHTML = orders.map(order => {
                    const statusClass = order.status === 'êµ¬ë§¤ ìŠ¹ì¸' ? 'approved' : 
                                      order.status === 'ì¤€ë¹„ì¤‘' ? 'preparing' : 'completed';
                    const userNickname = userMap[order.user_id] || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    
                    return `
                        <tr>
                            <td>${new Date(order.created_at).toLocaleDateString('ko-KR')}</td>
                            <td>
                                <img src="${order.product_image}" alt="${order.product_name}"><br>
                                ${order.product_name}
                            </td>
                            <td>${userNickname}</td>
                            <td>${order.product_price.toLocaleString()}ì›</td>
                            <td><span class="status-badge status-${statusClass}">${order.status}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="openOrderModal(${order.id})">
                                    ê´€ë¦¬
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function openOrderModal(orderId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${orderId}`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                
                const orders = await response.json();
                currentOrder = orders[0];

                const content = document.getElementById('orderDetailContent');
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <img src="${currentOrder.product_image}" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
                        <h3>${currentOrder.product_name}</h3>
                        <p>ê°€ê²©: ${currentOrder.product_price.toLocaleString()}ì›</p>
                        <p>í˜„ì¬ ìƒíƒœ: <strong>${currentOrder.status}</strong></p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ìƒíƒœ ë³€ê²½</label>
                        <select class="form-input" id="orderStatus">
                            <option value="êµ¬ë§¤ ìŠ¹ì¸" ${currentOrder.status === 'êµ¬ë§¤ ìŠ¹ì¸' ? 'selected' : ''}>êµ¬ë§¤ ìŠ¹ì¸</option>
                            <option value="ì¤€ë¹„ì¤‘" ${currentOrder.status === 'ì¤€ë¹„ì¤‘' ? 'selected' : ''}>ì¤€ë¹„ì¤‘</option>
                            <option value="ì „ì†¡ì™„ë£Œ" ${currentOrder.status === 'ì „ì†¡ì™„ë£Œ' ? 'selected' : ''}>ì „ì†¡ì™„ë£Œ</option>
                        </select>
                    </div>

                    ${currentOrder.status !== 'êµ¬ë§¤ ìŠ¹ì¸' ? `
                        <div class="form-group">
                            <label class="form-label">ì¿ í° ì´ë¯¸ì§€</label>
                            <input type="file" class="form-input" id="couponImage" accept="image/*">
                            ${currentOrder.coupon_image ? `<img src="${currentOrder.coupon_image}" style="width: 100%; margin-top: 10px; border-radius: 10px;">` : ''}
                        </div>

                        <div class="form-group">
                            <label class="form-label">ì‚¬ìš© ê¸°í•œ</label>
                            <input type="date" class="form-input" id="expiryDate" value="${currentOrder.expiry_date || ''}">
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="updateOrder()">ì €ì¥</button>
                        <button class="btn btn-danger" onclick="closeModal()">ì·¨ì†Œ</button>
                    </div>
                `;

                document.getElementById('orderModal').classList.add('active');
            } catch (error) {
                console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function updateOrder() {
            const status = document.getElementById('orderStatus').value;
            const expiryDate = document.getElementById('expiryDate')?.value;
            const couponImageFile = document.getElementById('couponImage')?.files[0];

            try {
                const updateData = {
                    status: status
                };

                // ìƒíƒœë³„ ì‹œê°„ ê¸°ë¡
                if (status === 'ì¤€ë¹„ì¤‘' && !currentOrder.preparing_at) {
                    updateData.preparing_at = new Date().toISOString();
                } else if (status === 'ì „ì†¡ì™„ë£Œ' && !currentOrder.completed_at) {
                    updateData.completed_at = new Date().toISOString();
                }

                if (expiryDate) {
                    updateData.expiry_date = expiryDate;
                }

                // ì¿ í° ì´ë¯¸ì§€ ì²˜ë¦¬
                if (couponImageFile) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        updateData.coupon_image = e.target.result;
                        await saveOrderUpdate(updateData);
                    };
                    reader.readAsDataURL(couponImageFile);
                } else {
                    await saveOrderUpdate(updateData);
                }
            } catch (error) {
                console.error('ì£¼ë¬¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function saveOrderUpdate(updateData) {
            await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${currentOrder.id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(updateData)
            });

            alert('ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal();
            await loadOrders();
        }

        function closeModal() {
            document.getElementById('orderModal').classList.remove('active');
            currentOrder = null;
        }
    </script>
</body>
</html>
